<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المخزون - RestoM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="navbar.css">
    <link rel="stylesheet" href="theme.css">

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Tajawal", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        /* ====== المحتوى ====== */
        .container {
            padding: 25px;
            display: flex;
            gap: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ==== جدول المخزون ==== */
        .inventory-box {
            flex: 65%;
            background: var(--card-bg);
            box-shadow: 0 3px 6px var(--shadow-color);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .inventory-box h2 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--primary);
            color: white;
            font-weight: bold;
        }

        .delete-btn,
        .update-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .update-btn {
            background: #3498db;
            color: white;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .update-btn:hover {
            background: #2980b9;
        }

        /* ==== إضافة منتج ==== */
        .add-box {
            flex: 35%;
            background: var(--card-bg);
            box-shadow: 0 3px 6px var(--shadow-color);
            padding: 20px;
            border-radius: 12px;
            height: fit-content;
            border: 1px solid var(--border-color);
        }

        .add-box h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        .add-box input {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 15px;
            background: var(--input-bg);
            color: var(--input-text);
        }

        .add-box button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background: var(--primary);
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .add-box button:hover {
            filter: brightness(1.1);
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>

    <!-- Navigation Bar -->
    <nav class="main-navbar">
        <div class="main-navbar-container">
            <a href="index.html" class="main-navbar-brand">
                <i class="fas fa-utensils"></i>
                RestoM
            </a>
            <button class="main-navbar-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <ul class="main-navbar-menu">
                <li class="main-navbar-item">
                    <a href="ordering.html" class="main-navbar-link">
                        <i class="fas fa-shopping-cart"></i>
                        الطلبات
                    </a>
                </li>
                <li class="main-navbar-item">
                    <a href="Tabels.html" class="main-navbar-link">
                        <i class="fas fa-table"></i>
                        الطاولات
                    </a>
                </li>
                <li class="main-navbar-item">
                    <a href="Inventory.html" class="main-navbar-link active">
                        <i class="fas fa-box"></i>
                        المخزون
                    </a>
                </li>
                <li class="main-navbar-item">
                    <a href="invoices.html" class="main-navbar-link">
                        <i class="fas fa-file-invoice"></i>
                        الفواتير
                    </a>
                </li>
                <li class="main-navbar-item">
                    <a href="Reports.html" class="main-navbar-link">
                        <i class="fas fa-chart-bar"></i>
                        التقارير
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- ====== المحتوى الرئيسي ====== -->
    <div class="container">

        <!-- جدول المخزون -->
        <div class="inventory-box">
            <h2>📦 قائمة المخزون</h2>
            <table>
                <thead>
                    <tr>
                        <th>اسم المنتج</th>
                        <th>السعر (د)</th>
                        <th>الكمية</th>
                        <th>تعديل</th>
                        <th>حذف</th>
                    </tr>
                </thead>
                <tbody id="inventory-table">
                    <!-- سيتم ملؤها بواسطة JS -->
                </tbody>
            </table>
        </div>

        <!-- صندوق الإضافة والتعديل -->
        <div class="add-box">
            <h3>➕ إضافة منتج</h3>
            <input id="product-name" type="text" placeholder="اسم المنتج">
            <input id="product-price" type="number" placeholder="السعر (دينار)">
            <input id="product-qty" type="number" placeholder="الكمية">
            <button onclick="addProduct()">✅ إضافة</button>

            <hr style="margin: 20px 0; border-color: var(--border-color);">

            <h3>🔄 تحديث كمية</h3>
            <input id="update-id" type="text" placeholder="ID" disabled>
            <input id="update-name" type="text" placeholder="اسم المنتج" disabled>
            <input id="update-qty" type="number" placeholder="الكمية الجديدة">
            <button class="update-btn" onclick="updateProduct()">🔄 تحديث الكمية</button>
        </div>

    </div>

    <script src="navbar.js"></script>
    <script>
        const API_URL = "https://localhost:7182/api/Products";
        let inventory = [];

        async function fetchProducts() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Failed to fetch products");

                inventory = await response.json();
                renderTable();
            } catch (error) {
                console.error("Error fetching products:", error);
                document.getElementById("inventory-table").innerHTML =
                    '<tr><td colspan="5" style="text-align:center; color:red;">خطأ في تحميل البيانات. تأكد من تشغيل الخادم.</td></tr>';
            }
        }

        function renderTable() {
            const tableBody = document.getElementById("inventory-table");
            tableBody.innerHTML = "";

            if (inventory.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">لا توجد منتجات في المخزون</td></tr>';
                return;
            }

            inventory.forEach(item => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td><button class="update-btn" onclick="prepareUpdate(${item.id})">تعديل</button></td>
                    <td><button class="delete-btn" onclick="deleteProduct(${item.id})">حذف</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function addProduct() {
            const name = document.getElementById("product-name").value;
            const price = Number(document.getElementById("product-price").value);
            const quantity = Number(document.getElementById("product-qty").value);

            console.log("Attempting to add product:", { name, price, quantity });

            if (!name || name.trim() === "") {
                alert("❗ الرجاء إدخال اسم المنتج");
                return;
            }

            if (!price || price <= 0) {
                alert("❗ الرجاء إدخال سعر صحيح");
                return;
            }

            if (quantity < 0) {
                alert("❗ الرجاء إدخال كمية صحيحة");
                return;
            }

            const newProduct = { name, price, quantity };
            console.log("Sending to API:", newProduct);

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(newProduct)
                });

                console.log("Response status:", response.status);

                if (response.ok) {
                    alert("✅ تمت إضافة المنتج بنجاح!");
                    fetchProducts();
                    document.getElementById("product-name").value = "";
                    document.getElementById("product-price").value = "";
                    document.getElementById("product-qty").value = "";
                } else {
                    const errorText = await response.text();
                    console.error("API Error:", errorText);
                    alert(`❌ فشل إضافة المنتج: ${response.status}\n${errorText}`);
                }
            } catch (error) {
                console.error("Error adding product:", error);
                alert(`❌ خطأ في الاتصال بالخادم: ${error.message}`);
            }
        }

        async function deleteProduct(id) {
            if (!confirm("هل أنت متأكد من الحذف؟")) return;

            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: "DELETE"
                });

                if (response.ok) {
                    fetchProducts();
                } else {
                    alert("فشل حذف المنتج");
                }
            } catch (error) {
                console.error("Error deleting product:", error);
            }
        }

        function prepareUpdate(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            document.getElementById("update-id").value = item.id;
            document.getElementById("update-name").value = item.name;
            document.getElementById("update-qty").value = item.quantity;
        }

        async function updateProduct() {
            const id = document.getElementById("update-id").value;
            const newQty = Number(document.getElementById("update-qty").value);

            if (!id) return alert("❗ اختر منتجاً للتعديل");
            if (newQty < 0) return alert("❗ الكمية غير صالحة");

            const item = inventory.find(i => i.id == id);
            if (!item) return;

            const updatedProduct = { ...item, quantity: newQty };

            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updatedProduct)
                });

                if (response.ok || response.status === 204) {
                    fetchProducts();
                    document.getElementById("update-id").value = "";
                    document.getElementById("update-name").value = "";
                    document.getElementById("update-qty").value = "";
                } else {
                    alert("فشل التحديث");
                }
            } catch (error) {
                console.error("Error updating product:", error);
            }
        }

        // Initialize
        fetchProducts();
    </script>
</body>

</html>