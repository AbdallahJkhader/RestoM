<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>واجهة الفواتير</title>

    <link rel="stylesheet" href="navbar.css">
    <link rel="stylesheet" href="theme.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Tajawal", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        /* ====== Header ====== */
        .header {
            background: #006d8f;
            color: white;
            padding: 18px 25px;
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            position: relative;
        }

        .header .icon {
            position: absolute;
            left: 25px;
            font-size: 26px;
            cursor: pointer;
        }

        /* ====== Layout Division ====== */
        .main-layout {
            display: flex;
            gap: 25px;
            padding: 25px;
        }

        /* ==== Invoice Items Box ==== */
        .bill-wrapper {
            background: white;
            width: 60%;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        .bill-wrapper h2 {
            margin-top: 0;
            color: #006d8f;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: #f1f1f1;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .item-row span {
            font-size: 18px;
        }

        /* ==== Payment Section ==== */
        .payment-box {
            width: 40%;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .payment-box h3 {
            margin-top: 0;
            color: #006d8f;
        }

        .payment-box select,
        .payment-box input {
            width: 100%;
            padding: 13px;
            margin-top: 10px;
            border-radius: 8px;
            border: 2px solid #ddd;
            font-size: 17px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 14px;
            margin-top: 20px;
            font-size: 18px;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            background: #009879;
            color: white;
        }

        button.print-btn {
            background: #006d8f;
        }
    </style>
</head>

<body>



    <!-- Navigation Bar -->
    <nav class="main-navbar">
        <div class="main-navbar-container">
            <a href="index.html" class="main-navbar-brand"><i class="fas fa-utensils"></i> RestoM</a>
            <button class="main-navbar-toggle"><i class="fas fa-bars"></i></button>
            <ul class="main-navbar-menu">
                <li class="main-navbar-item"><a href="ordering.html" class="main-navbar-link"><i
                            class="fas fa-shopping-cart"></i>
                        الطلبات</a></li>
                <li class="main-navbar-item"><a href="Tabels.html" class="main-navbar-link"><i class="fas fa-table"></i>
                        الطاولات</a></li>
                <li class="main-navbar-item"><a href="Inventory.html" class="main-navbar-link"><i
                            class="fas fa-box"></i>
                        المخزون</a></li>
                <li class="main-navbar-item"><a href="invoices.html" class="main-navbar-link"><i
                            class="fas fa-file-invoice"></i>
                        الفواتير</a></li>
                <li class="main-navbar-item"><a href="Reports.html" class="main-navbar-link"><i
                            class="fas fa-chart-bar"></i>
                        التقارير</a></li>
            </ul>
        </div>
    </nav>


    <div class="main-layout">
        <!-- Right: Invoice Details -->
        <div class="bill-wrapper" style="flex: 2;">
            <h2>تفاصيل الفاتورة</h2>
            <div id="invoice-details">
                <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
                    <i class="fas fa-file-invoice fa-4x" style="margin-bottom: 20px; opacity: 0.3;"></i>
                    <p>اختر فاتورة لعرض التفاصيل</p>
                </div>
            </div>

            <!-- Payment Section (inside invoice details) -->
            <div id="payment-section"
                style="display: none; margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--border-color);">
                <h3 style="color: var(--primary); margin-bottom: 15px;">💳 الدفع</h3>

                <label style="display: block; margin-bottom: 5px; font-weight: 600;">نوع الدفع:</label>
                <select id="payment-method"
                    style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border-color); margin-bottom: 15px; background: var(--bg-color); color: var(--text-color); font-size: 16px;">
                    <option value="cash">كاش</option>
                    <option value="card">بطاقة</option>
                </select>

                <label style="display: block; margin-bottom: 5px; font-weight: 600;">المبلغ المدفوع:</label>
                <input id="paid-amount" type="number" placeholder="ادخل المبلغ"
                    style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border-color); margin-bottom: 20px; background: var(--bg-color); color: var(--text-color); font-size: 16px; box-sizing: border-box;">

                <button onclick="completePayment()"
                    style="width: 100%; background: var(--success, #28a745); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 17px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                    ✅ إتمام الدفع والطباعة
                </button>
            </div>
        </div>

        <!-- Left: Invoices List -->
        <div class="bill-wrapper" style="flex: 1;">
            <h2>📋 قائمة الفواتير</h2>
            <div id="invoices-list"></div>
        </div>

    </div>

    <script>
        const API_URL = "https://localhost:7182/api/Orders";
        const TABLES_API_URL = "https://localhost:7182/api/Tables";
        let orders = [];
        let selectedInvoice = null;

        async function fetchOrders() {
            console.log("🔄 Fetching orders from API...");
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Failed to fetch orders");

                orders = await response.json();
                console.log("📦 Orders received:", orders.length);

                renderInvoicesLists();
            } catch (error) {
                console.error("❌ Error:", error);
                document.getElementById("current-invoices-list").innerHTML = `
                    <div style="text-align:center; padding:20px; color:red;">
                        <p>خطأ في تحميل الفواتير</p>
                    </div>
                `;
            }
        }

        function renderInvoicesLists() {
            const container = document.getElementById('invoices-list');

            if (orders.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:40px; color:var(--muted);">
                        <i class="fas fa-receipt fa-3x" style="margin-bottom:15px; opacity:0.3;"></i>
                        <p>لا توجد فواتير</p>
                        <p style="font-size:13px;">قم بإنشاء طلب من صفحة الطلبات</p>
                    </div>
                `;
                return;
            }

            // Sort: unpaid first, then by date  
            const sortedOrders = [...orders].sort((a, b) => {
                if (a.isPaid !== b.isPaid) return a.isPaid ? 1 : -1;
                return new Date(b.orderTime) - new Date(a.orderTime);
            });

            container.innerHTML = sortedOrders.map(order => `
                <div class="item-row" style="cursor: pointer; ${selectedInvoice?.id === order.id ? 'background: var(--primary); color: white;' : ''}" onclick="selectInvoice(${order.id})">
                    <div>
                        <strong>فاتورة #${order.id}</strong><br>
                        <span style="display: inline-block; margin-top: 5px; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; ${order.isPaid ? 'background: #28a745; color: white;' : 'background: #ffc107; color: #333;'}">
                            ${order.isPaid ? '✓ مدفوعة' : '⏳ غير مدفوعة'}
                        </span>
                    </div>
                    <span><strong>${(order.totalAmount + order.totalTax).toFixed(2)} د</strong></span>
                </div>
            `).join('');

            // Auto-select first unpaid invoice
            if (!selectedInvoice) {
                const firstUnpaid = sortedOrders.find(o => !o.isPaid);
                if (firstUnpaid) selectInvoice(firstUnpaid.id);
                else if (sortedOrders.length > 0) selectInvoice(sortedOrders[0].id);
            }
        }


        function selectInvoice(invoiceId) {
            selectedInvoice = orders.find(o => o.id === invoiceId);
            if (!selectedInvoice) return;

            const detailsContainer = document.getElementById('invoice-details');
            detailsContainer.innerHTML = `
                <div style="margin-bottom: 20px; padding: 15px; background: var(--hover-bg); border-radius: 8px;">
                    <h3>فاتورة #${selectedInvoice.id}</h3>
                    <p><strong>التاريخ:</strong> ${new Date(selectedInvoice.orderTime).toLocaleString('ar-EG')}</p>
                    <p><strong>الحالة:</strong> <span style="color: ${selectedInvoice.isPaid ? 'var(--success)' : 'var(--warning)'}">
                        ${selectedInvoice.isPaid ? 'مدفوعة ✓' : 'غير مدفوعة'}
                    </span></p>
                    ${selectedInvoice.notes ? `<p><strong>ملاحظات:</strong> ${selectedInvoice.notes}</p>` : ''}
                </div>
                ${selectedInvoice.items.map(item => `
                    <div class="item-row">
                        <span>${item.name} × ${item.quantity}</span>
                        <span>${(item.price * item.quantity).toFixed(2)} د</span>
                    </div>
                `).join('')}
                <div class="item-row" style="margin-top: 20px; background: #e3f2fd; font-weight: bold;">
                    <span>المجموع الفرعي:</span>
                    <span>${selectedInvoice.totalAmount.toFixed(2)} دينار</span>
                </div>
                <div class="item-row" style="background: #fff3cd; font-weight: bold;">
                    <span>الضريبة (5%):</span>
                    <span>${selectedInvoice.totalTax.toFixed(2)} دينار</span>
                </div>
                <div class="item-row" style="background: var(--primary); color: white; font-weight: bold; font-size: 18px;">
                    <span>الإجمالي:</span>
                    <span>${(selectedInvoice.totalAmount + selectedInvoice.totalTax).toFixed(2)} دينار</span>
                </div>
            `;

            const paymentSection = document.getElementById('payment-section');
            if (selectedInvoice.isPaid) {
                paymentSection.style.display = 'none';
            } else {
                paymentSection.style.display = 'block';
                document.getElementById('paid-amount').value = (selectedInvoice.totalAmount + selectedInvoice.totalTax).toFixed(2);
            }

            renderInvoicesLists();
        }

        async function completePayment() {
            if (!selectedInvoice || selectedInvoice.isPaid) {
                alert("⚠️ لا توجد فاتورة نشطة");
                return;
            }

            const paymentMethod = document.getElementById('payment-method').value;
            const paidAmount = parseFloat(document.getElementById('paid-amount').value);
            const totalAmount = selectedInvoice.totalAmount + selectedInvoice.totalTax;

            if (!paidAmount || paidAmount < totalAmount) {
                alert(`⚠️ المبلغ يجب أن يكون ${totalAmount.toFixed(2)} دينار على الأقل`);
                return;
            }

            try {
                selectedInvoice.isPaid = true;
                selectedInvoice.paymentMethod = paymentMethod;
                selectedInvoice.paidAmount = paidAmount;

                const response = await fetch(`${API_URL}/${selectedInvoice.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(selectedInvoice)
                });

                if (response.ok) {
                    if (selectedInvoice.tableId) {
                        await freeTable(selectedInvoice.tableId);
                    }

                    const change = paidAmount - totalAmount;
                    alert(`✅ تم الدفع!\n\nالمدفوع: ${paidAmount.toFixed(2)} د\nالباقي: ${change.toFixed(2)} د\n\n🖨️ جاري الطباعة...`);

                    await fetchOrders();
                    selectedInvoice = null;
                } else {
                    alert("❌ فشل تحديث الدفع");
                }
            } catch (error) {
                alert("❌ خطأ: " + error.message);
            }
        }

        async function freeTable(tableId) {
            try {
                const tableResponse = await fetch(`${TABLES_API_URL}/${tableId}`);
                const table = await tableResponse.json();
                table.isOccupied = false;

                await fetch(`${TABLES_API_URL}/${tableId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(table)
                });

                console.log(`✅ Table #${tableId} freed`);
            } catch (error) {
                console.error('Error freeing table:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', fetchOrders);
    </script>

    <script src="navbar.js"></script>
</body>

</html>